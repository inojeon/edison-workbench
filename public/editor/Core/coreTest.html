<!DOCTYPE html>
<html lang="en">
<head>
	<title>Kisti Cad</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>
<body style="overflow:hidden;margin:0px;">
	<div id="vrmoleapp" style="float:left;overflow:hidden;width:100%;height:100%;"></div>

	<script src="../CadEditor/zui/external/jquery/jquery.js"></script>
	<script src="../Core/jsbuild/kVisLib.js"></script>
    <script src="../Core/jsbuild/kVisLibBind.js"></script>
	<script type="module">

        import * as THREE from '../build/three.module.js';
        import { Renderer } from '../Renderer/Renderer.js';
        import { GeomRenderer } from '../Renderer/GeomRenderer.js';

        var renderer;
        var mouse = new THREE.Vector2(), SELECTED;
        var scoord = new THREE.Vector2();

        var cdiv = document.getElementById('vrmoleapp');


        function onDocumentMouseMove(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse move :"+mouse.x+" "+mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse move scoord :" + scoord.x + " " + scoord.y);

        }



        function onDocumentMouseDown(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse down :" + mouse.x + " " + mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse down scoord :" + scoord.x + " " + scoord.y);

        }
        function AddGeom(geomRenderer, lines) {
            var cmdList = new kVisLib.api.CommandList();
            lines = lines.split('\n');
            for(var i=0; i<lines.length; i++){
                var parsed = null;
                var id = -1;
                if(lines[i].startsWith("Group") == false){
                    parsed = cmdList.ParseCommand(lines[i]);
                    id = parsed.GetID();
                }
                if(parsed){   
                    parsed._preview = new kVisLib.api.Group();
                    parsed._preview.SetID(id);
                    parsed.GeneratePreview(parsed._preview);
                    geomRenderer.updateGeom(parsed._preview);
                }
            }
        }
        function test(geomRenderer){
            const fileUrl = '../_testdata/coreTest.krf'


            fetch(fileUrl)
                .then(r => r.text())
                .then(t => {
                    AddGeom(geomRenderer, t);
                    /*
                    geomRenderer.LoadFromString(t);

                    var gg = new geomRenderer._api.Sphere();
                    gg.Set(20, 0, 20, 4);
                    gg.SetID(6);

                    geomRenderer.addNewGeom(gg,100);
                    geomRenderer.setColor(4,1,1,1);
                    */
                });
        }

		kVisLib.Init(function () {

			renderer = new Renderer(cdiv, false, true);
			renderer.createPerspecriveCamera(100, 100, 100, 50, 1.5, 0.1, 1000);
			renderer.createOrbitControl();

            cdiv.addEventListener('pointerdown', onDocumentMouseDown);
            cdiv.addEventListener('pointermove', onDocumentMouseMove);

            window.addEventListener('resize', function () {
                cdiv.style.width = window.innerWidth + "px";
                cdiv.style.height = window.innerHeight + "px";
                renderer.onWindowResize(window.innerWidth, window.innerHeight);
            });

            renderer.onWindowResize(window.innerWidth, window.innerHeight);

            var gg = new GeomRenderer(kVisLib.api, renderer);
            test(gg);

            render();
        });



		function render() {
			requestAnimationFrame(render);

			renderer.tick();
			renderer.render();
		}




	</script>
</body>
</html>
