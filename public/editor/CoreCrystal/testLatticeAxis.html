<!DOCTYPE html>
<html lang="en">
<head>
	<title>Kisti Cad</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>
<body style="overflow:hidden;margin:0px;">
	<div id="vrmoleapp" style="float:left;overflow:hidden;width:100%;height:100%;"></div>

	<script src="../CadEditor/zui/external/jquery/jquery.js"></script>
	<script src="../Core/jsbuild/kVisLib.js"></script>
	<script src="../Core/jsbuild/kVisLibBind.js"></script>
	<script type="module">

        import * as THREE from '../build/three.module.js';
        import { Renderer } from '../Renderer/Renderer.js';
        import { GeomRenderer } from '../Renderer/GeomRenderer.js';
        import { Colormap } from '../Renderer/Colormap.js';
        import { Vector3 } from '../Math/Vector3.js';
        import { GeomMole } from '../Renderer/GeomMole.js';

        import { CStructure } from './CStructure.js';
        import { CAtom } from './CAtom.js';
        import { CBond } from './CBond.js';
        import { LatticeAxis } from './LatticeAxis.js';



        var l1 = new LatticeAxis(90, 90, 90, 1, 2, 3);
        var l2 = new LatticeAxis(120, 90, 90, 1, 2, 3);
        var l3 = new LatticeAxis(90, 120, 90, 1, 2, 3);
        var l4 = new LatticeAxis(90, 90, 120, 1, 2, 3);
        var l5 = new LatticeAxis(60, 60, 60, 1, 2, 3);


        var renderer;
        var mouse = new THREE.Vector2(), SELECTED;
        var scoord = new THREE.Vector2();

        var cdiv = document.getElementById('vrmoleapp');


        var cm = new Colormap();
        cm.addColor(0, 1, 0, 0);
        cm.addColor(0.5, 0, 1, 0);
        cm.addColor(1, 0, 0, 0);

        var c1 = cm.get(0.1);
        var c2 = cm.get(0.3);
        var c3 = cm.get(1);
        var c4 = cm.get(0.9);


        

        function onDocumentMouseMove(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse move :"+mouse.x+" "+mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse move scoord :" + scoord.x + " " + scoord.y);

        }



        function onDocumentMouseDown(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse down :" + mouse.x + " " + mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse down scoord :" + scoord.x + " " + scoord.y);

        }



        kVisLib.Init(function () {

            renderer = new Renderer(cdiv, false, true);
            renderer.create3DOrthographicCamera(-100, 100, 100, -100, 0, 1000);
            renderer.createPerspecriveCamera(100, 100, 100, 50, 1.5, 0.1, 1000);
            renderer.createOrbitControl();
            // renderer.createTrackballControl();
            renderer.createCameraLight();

            GeomMole.init();

            //cdiv.addEventListener('pointerdown', onDocumentMouseDown);
            //cdiv.addEventListener('pointermove', onDocumentMouseMove);

            window.addEventListener('resize', function () {
                cdiv.style.width = window.innerWidth + "px";
                cdiv.style.height = window.innerHeight + "px";
                renderer.onWindowResize(window.innerWidth, window.innerHeight);
            });

            renderer.onWindowResize(window.innerWidth, window.innerHeight);

            var gg = new GeomRenderer(kVisLib.api, renderer);

            // 데이터를 저장할 crystal structure 생성
            let cs = new CStructure();

            // Unit cell 정의
            cs._unitcell._a.set(5,0,0);
            cs._unitcell._b.set(0,5,0);
            cs._unitcell._c.set(0,0,5);

            // 아톰 하나 정의, CS에 추가
            let a1 = new CAtom();
            a1._position.set(.1, .1, .1);
            a1._label = "aa";
            a1.setAtomID(1);
            cs.addAtom(a1);

            // 아톰 하나 정의, CS에 추가
            let a2 = new CAtom();
            a2._position.set(.6, .4, .8);
            a2._label = "b";
            a2.setAtomID(8);
            cs.addAtom(a2);

            // 본드 하나 정의, CS에 추가
            let b1 = new CBond();
            b1.setLength(0, 8);
            b1.setAtom(1, 8);
            cs.addBond(b1);

            // 바운더리 정의
            cs._boundary.set(new Vector3(0, 0, 0), new Vector3(1, 1, 1));

            // three.mesh 생성
            cs.generate();

            // 생성된 메쉬를 three에 추가
            //let mesh1 = gg.addNewGeom2(cs._atomGeomGroup);
            //let mesh3 = gg.addNewGeom2(cs._bondGeomGroup);

            renderer._scene.add(cs._groupMesh);

            // unitcell 박스 메쉬 생성, 추가
            let uc = cs._unitcell.generateGeom();
            let mesh2 = gg.addNewGeom2(uc);

            renderer._scene.add(mesh2);


/*
            var sphere = new kVisLib.api.Sphere();
            sphere.Set(0, 0, 0, 10);
            sphere.SetID(-1);
            gg.addNewGeom(sphere);

            var geom1 = Util.generateDottedLineGeom(new THREE.Vector3(0, 0, 0), new THREE.Vector3(50, 50, 20));
            var mat1 = new THREE.MeshLambertMaterial({
                color: 0x0000ff
            });

            const mesh1 = new THREE.Mesh(geom1, mat1);
            renderer._scene.add(mesh1);



            var gg = new GeomRenderer(kVisLib.api, renderer);
            //var gg = new GeomRenderer(kVisLib.api, renderer, "../_resources/textures/point.png");



            var plist = new kVisLib.api.PointList();
            kVisLib.api.IntersectLineCircle(-2, 1, 2, 0, 0, 0, 2, plist);

            kVisLib.api.IntersectLineCircle(2, 0, -2, 1, 0, 0, 2, plist);

            var p1 = plist.GetPoint(0);
            var p2 = plist.GetPoint(1);
            var p3 = plist.GetPoint(2);
            var p4 = plist.GetPoint(3);

            var t = 32;



            var text1 = new kVisLib.api.Group();
            text1.GenerateString("HELLO12345", 2, 0, 0);
            text1.SetID(-1);
            gg.addNewGeom(text1);

            var sphere = new kVisLib.api.Sphere();
            sphere.Set(0, 0, 0, 1);
            sphere.SetID(-1);
            gg.addNewGeom(sphere);

            var line1 = new kVisLib.api.LineSeg();
            line1.Set(-10, -2, 0, 10, 2, 0);
            line1.SetID(-1);
            gg.addNewGeom(line1);

            var dim1 = new kVisLib.api.Dim();
            dim1.Set(line1, 0, 2, 1, 1);

            var group1 = new kVisLib.api.Group();
            group1.SetID(-1);

            dim1.GeneratePreview(group1);

            var n1 = group1.GetNumberOfChildren();

            gg.addNewGeom(group1);


            var dim2 = new kVisLib.api.Dim();
            dim2.SetAngle(0,0,20,-5,-4,20, 16);

            var group2 = new kVisLib.api.Group();
            group2.SetID(-1);

            dim2.GeneratePreview(group2);
            gg.addNewGeom(group2);


            var circle1 = new kVisLib.api.Circle();
            circle1.Set(50, 2, 0, 15);
            circle1.SetID(-1);
            gg.addNewGeom(circle1);

            var dim3 = new kVisLib.api.Dim();
            dim3.SetDimRadius(circle1, 6, 30*3.14/180.0);

            var group3 = new kVisLib.api.Group();
            group3.SetID(-1);

            dim3.GeneratePreview(group3);
            gg.addNewGeom(group3);

            var circle2 = new kVisLib.api.Circle();
            circle2.Set(-25, 2, 0, 10);
            circle2.SetID(-1);
            gg.addNewGeom(circle2);

            var dim4 = new kVisLib.api.Dim();
            dim4.SetDimDiameter(circle2, 6, 70 * 3.14 / 180.0);

            var group4 = new kVisLib.api.Group();
            group4.SetID(-1);

            dim4.GeneratePreview(group4);
            gg.addNewGeom(group4);
*/
            //gg.test1();
            /*
            var spline = new kVisLib.api.Spline();
            spline.AddPoint(0, 0, 0);
            spline.AddPoint(10, 0, 0);
            //spline.AddPoint(0, 10, 0);
            //spline.AddPoint(0, 0, 10);
            //spline.AddPoint(0, 10, 10);
            //spline.AddPoint(10, 10, 10);
            //spline.AddPoint(10, 20, 0);
            //spline.AddPoint(20, 30, 10);
            //spline.AddPoint(30, 40, 30);

            //gg.addNewGeom(spline);


            var ps = new kVisLib.api.PointList();
            ps.SetID(15);
            ps.AddPoint(0, 0, 0);
            ps.AddPoint(20, 0, 20);
            ps.AddPoint(1, 4, 2);
            ps.AddPoint(2, 4, 3);
            ps.AddPoint(3, 4, 4);
            ps.AddPoint(4, 4, 5);
            ps.AddPoint(5, 4, 6);

            gg.addNewGeom(ps);

            var ps2 = new kVisLib.api.PointList();
            ps2.SetID(16);

            var pp;
            var pt1 = new ptSplinePoint();
            pp = pt1;
            pp.setType(0);
            pp.setPos(new THREE.Vector3(0, 0, 0));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(0, 3, 0));

            var pt2 = new ptSplinePoint();
            pp = pt2;
            pp.setType(0);
            pp.setPos(new THREE.Vector3(0, 3, 0));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(0, 6, 0));

            var pt3 = new ptSplinePoint();
            pp = pt3;
            pp.setType(2);
            pp.setPos(new THREE.Vector3(0, 6, 0));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(0, 9, 0));

            var pt4 = new ptSplinePoint();
            pp = pt4;
            pp.setType(2);
            pp.setPos(new THREE.Vector3(0, 9, 1));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(0, 12, 0));

            var pt5 = new ptSplinePoint();
            pp = pt5;
            pp.setType(2);
            pp.setPos(new THREE.Vector3(1, 12, 0));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(0, 15, 0));

            var pt6 = new ptSplinePoint();
            pp = pt6;
            pp.setType(0);
            pp.setPos(new THREE.Vector3(1, 15, 0));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(0, 18, 0));

            var pt7 = new ptSplinePoint();
            pp = pt7;
            pp.setType(0);
            pp.setPos(new THREE.Vector3(1, 18, 0));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(2, 21, 4));

            var pt8 = new ptSplinePoint();
            pp = pt8;
            pp.setType(0);
            pp.setPos(new THREE.Vector3(2, 21, 4));
            pp.setNormal(new THREE.Vector3(0, 0, 1));
            pp.setForward(new THREE.Vector3(2, 22, 4));



            var PT = new ProteinTrajectory();

            PT.add(pt1);
            PT.add(pt2);
            PT.add(pt3);
            PT.add(pt4);
            PT.add(pt5);
            PT.add(pt6);
            PT.add(pt7);
            PT.add(pt8);
            

            //var mesh = PT.generateMesh();
            //gg.updateMesh(mesh, ps2, gg._group);

*/

            render();
        });


		function render() {
			requestAnimationFrame(render);

            renderer.tick();
            renderer.render();
		}




	</script>
</body>
</html>
