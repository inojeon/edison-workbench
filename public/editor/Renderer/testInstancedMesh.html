<!DOCTYPE html>
<html lang="en">
<head>
	<title>Kisti Cad</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>
<body style="overflow:hidden;margin:0px;">
	<div id="vrmoleapp" style="float:left;overflow:hidden;width:100%;height:100%;"></div>

	<script src="../CadEditor/zui/external/jquery/jquery.js"></script>
	<script src="../Core/jsbuild/kVisLib.js"></script>
	<script src="../Core/jsbuild/kVisLibBind.js"></script>
	
    <script type="module">

        import * as THREE from '../build/three.module.js';
        import { Renderer } from './Renderer.js';
        import { GeomRenderer } from './GeomRenderer.js';
        import { tProtein } from '../ProteinRenderer/tProtein.js';
        import Stats from './jsm/libs/stats.module.js';

        var renderer;
        var mouse = new THREE.Vector2(), SELECTED;
        var scoord = new THREE.Vector2();

        const REP = 1500;
        const AREA = 300;

        var cdiv = document.getElementById('vrmoleapp');

        var stats = new Stats();
        stats.showPanel(0);
        document.body.appendChild(stats.dom);

        function onDocumentMouseMove(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse move :"+mouse.x+" "+mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse move scoord :" + scoord.x + " " + scoord.y);

        }




        function onDocumentMouseDown(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse down :" + mouse.x + " " + mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse down scoord :" + scoord.x + " " + scoord.y);

        }

        function makeInstanced(renderer, geometry) {

            const matrix = new THREE.Matrix4();
            const material = new THREE.MeshNormalMaterial();
            const count = 300;
            const mesh = new THREE.InstancedMesh(geometry, material, count);

            for(let i=0; i<count; ++i) {
                randomizeMatrix( matrix );
                mesh.setMatrixAt(i, matrix);
            }

            renderer._scene.add(mesh);
        }

        const randomizeMatrix = function () {

        const position = new THREE.Vector3();
        const rotation = new THREE.Euler();
        const quaternion = new THREE.Quaternion();
        const scale = new THREE.Vector3();

        return function ( matrix ) {

            position.x = Math.random() * 40 - 20;
            position.y = Math.random() * 40 - 20;
            position.z = Math.random() * 40 - 20;

            rotation.x = Math.random() * 2 * Math.PI;
            rotation.y = Math.random() * 2 * Math.PI;
            rotation.z = Math.random() * 2 * Math.PI;

            quaternion.setFromEuler( rotation );

            scale.x = scale.y = scale.z = Math.random() * 1;

            matrix.compose( position, quaternion, scale );

        };

        }();

        kVisLib.Init(function () {

        renderer = new Renderer(cdiv, false, true);
        renderer.createPerspecriveCamera(100, 100, 100, 50, 1.5, 0.1, 1000);
        renderer.create3DOrthographicCamera(-100, 100, 100, -100, 0, 1000);
        renderer.createOrbitControl();
        renderer.createCameraLight();
        renderer.setLightMode(0);

        window.addEventListener('resize', function () {
                cdiv.style.width = window.innerWidth + "px";
                cdiv.style.height = window.innerHeight + "px";
                renderer.onWindowResize(window.innerWidth, window.innerHeight);
            });

            renderer.onWindowResize(window.innerWidth, window.innerHeight);

            let geometry = new THREE.SphereGeometry(1,32,32);
            geometry.computeVertexNormals();
            makeInstanced(renderer, geometry);
            // let geom = new THREE.SphereGeometry(30,32,32);
            // let material = new THREE.MeshBasicMaterial({color: 0x4488aa});
            // let mesh = new THREE.Mesh(geom, material);
            // renderer._scene.add(mesh);
            render();
        });


		function render() {
			requestAnimationFrame(render);

            stats.update();
            renderer.tick();
            renderer.render();
		}

	</script>
</body>
</html>
