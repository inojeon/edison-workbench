<!DOCTYPE html>
<html lang="en">
<head>
	<title>Kisti Cad</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>
<body style="overflow:hidden;margin:0px;">
	<div id="vrmoleapp" style="float:left;overflow:hidden;width:100%;height:100%;"></div>

	<script src="../CadEditor/zui/external/jquery/jquery.js"></script>
	<script src="../Core/jsbuild/kVisLib.js"></script>
	<script src="../Core/jsbuild/kVisLibBind.js"></script>
	
    <script type="module">

        import * as THREE from '../build/three.module.js';
        import { Renderer } from './Renderer.js';
        import { GeomRenderer } from './GeomRenderer.js';
        import { tProtein } from '../ProteinRenderer/tProtein.js';
        import Stats from './jsm/libs/stats.module.js';

        const REP = 100;
        const AREA = 100;

        var renderer;
        var mouse = new THREE.Vector2(), SELECTED;
        var scoord = new THREE.Vector2();

        var cdiv = document.getElementById('vrmoleapp');

        var stats = new Stats();
        stats.showPanel(0);
        document.body.appendChild(stats.dom);

        function onDocumentMouseMove(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse move :"+mouse.x+" "+mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse move scoord :" + scoord.x + " " + scoord.y);

        }




        function onDocumentMouseDown(event) {

            event.preventDefault();

            mouse.x = event.clientX;
            mouse.y = event.clientY;

            //console.log("mouse down :" + mouse.x + " " + mouse.y);

            scoord.x = mouse.x / cdiv.clientWidth;
            scoord.y = mouse.y / cdiv.clientHeight;

            //console.log("mouse down scoord :" + scoord.x + " " + scoord.y);

        }



        kVisLib.Init(function () {

            renderer = new Renderer(cdiv, false, true);
            renderer.create3DOrthographicCamera(-100, 100, 100, -100, 0, 1000);
            renderer.createPerspecriveCamera(100, 100, 100, 50, 1.5, 0.1, 1000);
            //renderer.createOrbitControl();
            renderer.createTrackballControl();
            renderer.createCameraLight();

            //cdiv.addEventListener('pointerdown', onDocumentMouseDown);
            //cdiv.addEventListener('pointermove', onDocumentMouseMove);

            window.addEventListener('resize', function () {
                cdiv.style.width = window.innerWidth + "px";
                cdiv.style.height = window.innerHeight + "px";
                renderer.onWindowResize(window.innerWidth, window.innerHeight);
            });

            renderer.onWindowResize(window.innerWidth, window.innerHeight);

            let geom_renderer = new GeomRenderer(kVisLib.api, renderer, '');
        
            // 검은 구체 : 원점
            // 진파랑 '', 진빨강 : 실린더 시작, 끝
            // 옅은 파랑 실린더, 구체 : 생성한 bond, atom
            //geom_renderer.testGenSphereCylinder(false);
            //geom_renderer.testGenSphereCylinder(true);

            /*
            static 함수니까
            tProtein, tChain에 각각 만들면 된다
            testMEAtomList.html에 예제가 있으니
            atomlist, bondlist 가져오는 예제 보고 만들기
            atomlist, bondlist를 받아 만드는 걸 geomRenderer에 추가하기

            bond data는 좀 structure가 다르다
            */
            let sphereSize = GeomRenderer.getSizeGeomSphere(32, 32);
            let len1 = sphereSize[1] * REP;
            let len2 = sphereSize[0] * REP;

            let vidx = 0, nidx = 0, iidx = 0;
            let vclist = [];
            let vlist = new Array(len1);
            let nlist = new Array(len1);
            let ilist = new Array(len2);
            let radius = 5;

            let color = new THREE.Color(0xffff00);
            for(let i = 0; i < REP; ++i) {
                let pos = new THREE.Vector3(Math.random() * AREA, Math.random() * AREA, Math.random() * AREA);
                [vidx, nidx, iidx] = GeomRenderer.genGeomSphere(vlist, vidx, nlist, nidx, ilist, iidx, vclist, pos, radius, color, 32, 32);
            }

            let geometry = new THREE.BufferGeometry();
            const positionAttr = new THREE.Float32BufferAttribute(vlist, 3);
            const normalAttr = new THREE.Float32BufferAttribute(nlist, 3);
            const count = vlist.length;

            // geometry.setAttribute('color', new THREE.BufferAttribute(new Float32Array(count * 3), 3));
            geometry.setAttribute('position', positionAttr);
            geometry.setAttribute('normal', normalAttr);
            geometry.setIndex(ilist);
            
            let material = new THREE.ShaderMaterial({
            uniforms: uniforms,
            vertexColors: true,
            fragmentShader: fragmentShader(),
            vertexShader: vertexShader(),
            lights: true,
            });

            let mesh = new THREE.Mesh(geometry, material);
            
            renderer._scene.add(mesh);
            
            render();
        });


		function render() {
			requestAnimationFrame(render);

            renderer._camera.rotation._x += 0.5;
            stats.begin();
            renderer.tick();
            renderer.render();
            stats.end();
		}

// vertex shader 정의
function vertexShader() {
    return `
    varying vec3 vUv; 
    varying vec4 modelViewPosition; 
    varying vec3 vecNormal;
    varying vec3 v_color;

    void main() {
      v_color = vec3(color);
      vUv = position; 
      vec4 modelViewPosition = modelViewMatrix * vec4(position, 1.0);
      vecNormal = (modelViewMatrix * vec4(normal, 0.0)).xyz; //????????
      gl_Position = projectionMatrix * modelViewPosition; 
    }
  `;
}


function fragmentShader() {
    return `

    void main() {
    gl_FragColor = vec4(0.0, 0.5, 1.0, 1.0); // R, G, B, A
    }
    `
}


let uniforms = {};
        uniforms = THREE.UniformsUtils.merge([
            uniforms,
            THREE.UniformsLib['lights']
        ]);
        


	</script>
</body>
</html>
